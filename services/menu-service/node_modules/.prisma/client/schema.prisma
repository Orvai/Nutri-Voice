generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////

enum DayType {
  TRAINING
  REST
}

enum MealTemplateKind {
  MEAT_MEAL
  DAIRY_MEAL
  FREE_CALORIES
  CARB_LOAD
}

enum MealItemRole {
  PROTEIN
  CARB
  FREE
  HEALTH
  MENTAL_HEALTH
}

//////////////////////////////////////////////////
// FOOD MASTER DATA
//////////////////////////////////////////////////

model FoodItem {
  id              String  @id @default(cuid())
  name            String
  description     String?
  category        String
  caloriesPer100g Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templateItems MealTemplateItem[]
  optionItems   ClientMenuMealOptionItem[]
}

model VitaminMaster {
  id          String  @id @default(cuid())
  name        String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templateVitamins TemplateMenuVitamin[]
  clientVitamins   ClientMenuVitamin[]
}

//////////////////////////////////////////////////
// MEAL TEMPLATES (Reusable)
//////////////////////////////////////////////////

model MealTemplate {
  id      String           @id @default(cuid())
  name    String
  kind    MealTemplateKind
  coachId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items MealTemplateItem[]

  templateOptions TemplateMenuMealOption[]
  clientOptions   ClientMenuMealOption[]
}

model MealTemplateItem {
  id             String @id @default(cuid())
  mealTemplateId String
  foodItemId     String

  role  MealItemRole
  grams Float        @default(100)

  foodItem     FoodItem     @relation(fields: [foodItemId], references: [id], onDelete: Restrict)
  mealTemplate MealTemplate @relation(fields: [mealTemplateId], references: [id], onDelete: Cascade)

  @@index([mealTemplateId])
  @@index([foodItemId])
}

//////////////////////////////////////////////////
// TEMPLATE MENUS
//////////////////////////////////////////////////

model TemplateMenu {
  id            String  @id @default(cuid())
  coachId       String
  name          String
  dayType       DayType
  notes         String?
  totalCalories Float   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  meals    TemplateMenuMeal[]
  vitamins TemplateMenuVitamin[]
  clients  ClientMenu[]
}

model TemplateMenuMeal {
  id             String @id @default(cuid())
  templateMenuId String

  name          String
  notes         String?
  totalCalories Float

  options TemplateMenuMealOption[]

  templateMenu TemplateMenu @relation(fields: [templateMenuId], references: [id], onDelete: Cascade)

  @@index([templateMenuId])
}

model TemplateMenuMealOption {
  id             String @id @default(cuid())
  mealId         String
  mealTemplateId String

  name       String?
  orderIndex Int     @default(0)

  meal         TemplateMenuMeal @relation(fields: [mealId], references: [id], onDelete: Cascade)
  mealTemplate MealTemplate     @relation(fields: [mealTemplateId], references: [id], onDelete: Restrict)

  @@index([mealId])
}

model TemplateMenuVitamin {
  id             String @id @default(cuid())
  templateMenuId String

  vitaminId   String?
  name        String
  description String?

  templateMenu TemplateMenu   @relation(fields: [templateMenuId], references: [id], onDelete: Cascade)
  vitamin      VitaminMaster? @relation(fields: [vitaminId], references: [id], onDelete: Restrict)

  @@index([templateMenuId])
  @@index([vitaminId])
}

//////////////////////////////////////////////////
// CLIENT MENUS
//////////////////////////////////////////////////

model ClientMenu {
  id       String @id @default(cuid())
  clientId String
  coachId  String

  name          String
  type          DayType
  notes         String?
  isActive      Boolean @default(true)
  totalCalories Float   @default(0)

  startDate DateTime?
  endDate   DateTime?

  originalTemplateMenuId String?
  originalTemplateMenu   TemplateMenu? @relation(fields: [originalTemplateMenuId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  meals    ClientMenuMeal[]
  vitamins ClientMenuVitamin[]

  @@index([clientId, isActive])
  @@index([coachId])
}

model ClientMenuMeal {
  id           String @id @default(cuid())
  clientMenuId String

  name             String
  notes            String?
  totalCalories    Float
  selectedOptionId String?

  clientMenu ClientMenu             @relation(fields: [clientMenuId], references: [id], onDelete: Cascade)
  options    ClientMenuMealOption[]

  @@index([clientMenuId])
}

model ClientMenuMealOption {
  id               String @id @default(cuid())
  clientMenuMealId String

  // optional origin
  mealTemplateId String?

  name       String?
  orderIndex Int     @default(0)

  items ClientMenuMealOptionItem[]

  clientMenuMeal ClientMenuMeal @relation(fields: [clientMenuMealId], references: [id], onDelete: Cascade)
  mealTemplate   MealTemplate?  @relation(fields: [mealTemplateId], references: [id], onDelete: Restrict)

  @@index([clientMenuMealId])
}

model ClientMenuMealOptionItem {
  id         String @id @default(cuid())
  optionId   String
  foodItemId String

  role  MealItemRole
  grams Float        @default(100)

  option   ClientMenuMealOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  foodItem FoodItem             @relation(fields: [foodItemId], references: [id], onDelete: Restrict)

  @@index([optionId])
  @@index([foodItemId])
}

model ClientMenuVitamin {
  id           String @id @default(cuid())
  clientMenuId String

  vitaminId   String?
  name        String
  description String?
  notes       String?

  clientMenu ClientMenu     @relation(fields: [clientMenuId], references: [id], onDelete: Cascade)
  vitamin    VitaminMaster? @relation(fields: [vitaminId], references: [id], onDelete: Restrict)

  @@index([clientMenuId])
  @@index([vitaminId])
}
