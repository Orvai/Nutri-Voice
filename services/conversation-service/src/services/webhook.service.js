const { prisma } = require("../db/prisma");
const { getUserByPhone } = require("../clients/idm.client");
const { getOrCreateConversation } = require("./conversation.service");
const {
  createClientMessage,
  createAiMessage,
} = require("./message.service");
const { triageClientMessage } = require("./aiTriage.service");
const { sendMessageExternally } = require("./sendMessageExternally.service");

/**
 * Internal orchestration ONLY
 */
const handleIncomingMessage = async ({
  fromPhone,
  toPhone,
  channel,
  contentType,
  text,
  media,
  sourceMessageId,
}) => {
  console.log("ğŸš€ handleIncomingMessage START", {
    fromPhone,
    toPhone,
    channel,
    contentType,
    hasText: !!text,
    hasMedia: !!media,
    sourceMessageId,
  });

  /* =========================
     1ï¸âƒ£ Resolve identities
  ========================= */
  console.log("â¡ï¸ [1] Resolving identities");

  let fromUser, toUser;
  try {
    fromUser = await getUserByPhone(fromPhone);
    console.log("âœ… [1.1] fromUser resolved", fromUser);

    toUser = await getUserByPhone(toPhone);
    console.log("âœ… [1.2] toUser resolved", toUser);
  } catch (err) {
    console.error("ğŸ’¥ [1] Failed resolving identities", err);
    throw err;
  }

  if (!fromUser || !toUser) {
    console.error("ğŸ’¥ [1] Unknown external identity", {
      fromUser,
      toUser,
    });
    throw new Error("Unknown external identity");
  }

  if (fromUser.role !== "client") {
    console.error("ğŸ’¥ [1] fromUser is not CLIENT", fromUser.role);
    throw new Error("Incoming message must be from CLIENT");
  }

  if (toUser.role !== "coach") {
    console.error("ğŸ’¥ [1] toUser is not COACH", toUser.role);
    throw new Error("Incoming message must be to COACH");
  }

  const clientId = fromUser.id;
  const coachId = toUser.id;

  /* =========================
     2ï¸âƒ£ Conversation
  ========================= */
  console.log("â¡ï¸ [2] Resolving conversation", {
    clientId,
    coachId,
    channel,
  });

  let conversation;
  try {
    conversation = await getOrCreateConversation({
      coachId,
      clientId,
      channel,
    });
    console.log("âœ… [2] Conversation resolved", {
      id: conversation.id,
    });
  } catch (err) {
    console.error("ğŸ’¥ [2] Failed resolving conversation", err);
    throw err;
  }

  /* =========================
     3ï¸âƒ£ CLIENT Message
  ========================= */
  console.log("â¡ï¸ [3] Creating client message");

  let clientMessage;
  try {
    clientMessage = await createClientMessage({
      conversationId: conversation.id,
      contentType,
      text,
      media,
      sourceMessageId,
    });
    console.log("âœ… [3] Client message created", {
      id: clientMessage.id,
    });
  } catch (err) {
    console.error("ğŸ’¥ [3] Failed creating client message", err);
    throw err;
  }

  /* =========================
     4ï¸âƒ£ AI Triage
  ========================= */
  console.log("â¡ï¸ [4] Running AI triage (MCP)", {
    messageId: clientMessage.id,
  });

  try {
    await triageClientMessage({ messageId: clientMessage.id });
    console.log("âœ… [4] AI triage finished");
  } catch (err) {
    console.error("ğŸ’¥ [4] AI triage failed", err);
    throw err;
  }

  let updatedMessage;
  try {
    updatedMessage = await prisma.message.findUnique({
      where: { id: clientMessage.id },
    });
    console.log("âœ… [4.1] Message reloaded after AI", {
      aiDecision: updatedMessage?.aiDecision,
      hasSuggestedReply: !!updatedMessage?.aiSuggestedReply,
    });
  } catch (err) {
    console.error("ğŸ’¥ [4.1] Failed loading message after AI", err);
    throw err;
  }

  /* =========================
     5ï¸âƒ£ AUTO_REPLY execution
  ========================= */
  if (
    updatedMessage?.aiDecision === "AUTO_REPLY" &&
    updatedMessage?.aiSuggestedReply
  ) {
    console.log("â¡ï¸ [5] AUTO_REPLY path triggered");

    let aiMessage;
    try {
      aiMessage = await createAiMessage({
        conversationId: conversation.id,
        text: updatedMessage.aiSuggestedReply,
        autoGenerated: true,
      });
      console.log("âœ… [5.1] AI message created", {
        id: aiMessage.id,
      });
    } catch (err) {
      console.error("ğŸ’¥ [5.1] Failed creating AI message", err);
      throw err;
    }

    try {
      console.log("â¡ï¸ [5.2] Sending AI message externally", {
        messageId: aiMessage.id,
      });
      await sendMessageExternally(aiMessage.id);
      console.log("âœ… [5.2] AI message sent externally");
    } catch (err) {
      console.error("ğŸ’¥ [5.2] Failed sending AI message externally", err);
      throw err;
    }
  } else {
    console.log("â„¹ï¸ [5] No AUTO_REPLY â€“ nothing to send");
  }

  console.log("ğŸ handleIncomingMessage END â€“ SUCCESS");
  return { ok: true };
};

module.exports = { handleIncomingMessage };
