generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =============================================================================
 * ENUMS
 * =============================================================================
 */

enum MessageSender {
  CLIENT
  COACH
  AI
}

enum AIDecision {
  AUTO_REPLY
  COACH_REPLY
}

enum MessageHandledBy {
  AI
  COACH
}

enum ConversationChannel {
  WHATSAPP
  TELEGRAM
  APP
}

enum MessageContentType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
}

/**
 * =============================================================================
 * CONVERSATION
 * =============================================================================
 */

model Conversation {
  id String @id @default(cuid())

  coachId  String
  clientId String
  channel  ConversationChannel

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime?

  messages Message[]

  @@unique([coachId, clientId, channel])
  @@index([coachId])
  @@index([clientId])
}

/**
 * =============================================================================
 * MESSAGE
 * =============================================================================
 */

model Message {
  id String @id @default(cuid())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  /**
   * =========================
   * Core message identity
   * =========================
   */

  sender    MessageSender
  createdAt DateTime      @default(now())

  /**
   * =========================
   * Content (TEXT / IMAGE / AUDIO / VIDEO)
   * =========================
   */

  contentType MessageContentType

  // TEXT only
  text String?

  // MEDIA only (IMAGE/AUDIO/VIDEO)
  mediaUrl         String?
  mediaMimeType    String?
  mediaDurationSec Int?
  mediaThumbnail   String?

  /**
   * =========================
   * AI decision layer
   * (relevant ONLY for CLIENT)
   * =========================
   */

  aiDecision       AIDecision?
  aiSuggestedReply String?

  /**
   * =========================
   * Handling lifecycle
   * (relevant ONLY for CLIENT)
   * =========================
   */

  handledAt DateTime?
  handledBy MessageHandledBy?

  /**
   * =========================
   * Linking & metadata
   * =========================
   */

  sourceMessageId String?
  autoGenerated   Boolean @default(false)

  /**
   * =========================
   * Indexes
   * =========================
   */

  @@index([conversationId])
  @@index([sender])
  @@index([handledAt])
  @@index([aiDecision])
  @@index([contentType])
}
